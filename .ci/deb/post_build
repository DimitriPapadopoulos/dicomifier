#!/bin/sh

set -ev

export WORKSPACE=${WORKSPACE:?}
export BUILD_DIR="${WORKSPACE}/${BUILD_DIR:-build}"
export INSTALL_DIR="${WORKSPACE}/${INSTALL_DIR:-install}"

PYTHON=$(awk -F= '$0 ~ /^PYTHON_EXECUTABLE:/ { print $2 }' ${BUILD_DIR}/CMakeCache.txt)

export LD_LIBRARY_PATH=${INSTALL_DIR}/lib
export PYTHONPATH=${INSTALL_DIR}/$(${PYTHON} -c "from distutils.sysconfig import *; print(get_python_lib(True, prefix=''))")

export DICOMIFIER_TEST_DATA=${WORKSPACE}/tests/data

cd "${BUILD_DIR}"

ctest -T Test
${PYTHON} -m unittest discover -s ${WORKSPACE}/tests/python/

cd ${HOME}
# WARNING: 467 MB archived, 807 MB unzipped
wget -qO - https://github.com/fli-iam/dicomifier-data/archive/master.tar.gz ‚Å†\
  | tar -x -z -f -

export PATH=${INSTALL_DIR}/bin:${PATH}
${PYTHON} ./dicomifier-data-master/scripts/diff_bruker2dicom.py
${PYTHON} ./dicomifier-data-master/scripts/diff_dicom2nifti.py

rm -rf dicomifier-data-master
