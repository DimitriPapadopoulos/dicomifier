#!${PYTHON_EXECUTABLE}

import argparse
import logging
import os
import sys

import numpy

import dicomifier

def main():
    parser = argparse.ArgumentParser(description="Convert DICOM to NIfTI")
    parser.add_argument(
        "paths", nargs="+", 
        help="DICOM file, directory or DICOMDIR", metavar="path")
    parser.add_argument("destination", help="Output directory")
    parser.add_argument(
        "--dtype", "-d", default=None, 
        type=lambda x: None if x is None else getattr(numpy, x),
        help="Pixel type")
    parser.add_argument(
        "--zip", "-z", action="store_true", help="Compress NIfTI files")
    parser.add_argument(
        "--parallel", "-j", default=None, 
        help="Parallelize the conversion of each series")
    parser.add_argument(
        "--verbosity", "-v",
        choices=["warning", "info", "debug"], default="warning")

    arguments = vars(parser.parse_args())
    if arguments["parallel"] is not None:
        if arguments["parallel"] in ["auto", "0", ""]:
            arguments["parallel"] = os.cpu_count()
        else:
            try:
                arguments["parallel"] = int(arguments["parallel"])
            except ValueError as e:
                parser.error("Parallel option must be int or \"auto\"")
    
    verbosity = arguments.pop("verbosity")
    logging.basicConfig(
        level=verbosity.upper(), 
        format="%(levelname)s - %(name)s: %(message)s")

    try:
        dicomifier.dicom_to_nifti.convert.convert_paths(**arguments)
    except Exception as e:
        if verbosity == "debug":
            raise
        else:
            parser.error(e)

if __name__ == "__main__":
    sys.exit(main())
